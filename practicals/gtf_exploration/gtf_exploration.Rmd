---
title: "Exploration d'une table d'annotations génomiques (GTF)"
author: "Jacques van Helden"
date: '`r Sys.Date()`'
output:
  slidy_presentation:
    code_folding: hide
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    highlight: tango
    incremental: no
    keep_md: no
    smaller: yes
    theme: cerulean
    toc: yes
    toc_float: yes
    widescreen: yes
  html_notebook:
    editor_options: 
      chunk_output_type: inline
  beamer_presentation:
    colortheme: dolphin
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    fonttheme: structurebold
    highlight: tango
    incremental: no
    keep_tex: no
    slide_level: 2
    theme: Montpellier
    toc: yes
  html_document:
    code_folding: show
    fig_caption: yes
    highlight: zenburn
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    fig_caption: yes
    highlight: zenburn
    toc: yes
    toc_depth: 3
  ioslides_presentation:
    colortheme: dolphin
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    fonttheme: structurebold
    highlight: tango
    incremental: no
    keep_md: no
    smaller: yes
    theme: cerulean
    toc: yes
    widescreen: yes
  word_document:
    toc: yes
    toc_depth: 3
font-import: http://fonts.googleapis.com/css ?family=Risque
font-family: Garamond
subtitle: Probabilités et statistique pour la biologie (STAT1)
address: TAGC lab, Aix-Marseille Université, France
transition: linear
---

```{r setup, include=FALSE, size="huge"}
library(knitr)
## Default parameters for displaying the slides
knitr::opts_chunk$set(
  echo = TRUE, 
  eval=TRUE, 
  fig.width = 7, 
  fig.height = 5, 
  fig.align = "center", 
  fig.path = "figures/",
  size = "tiny", 
  warning = FALSE, 
  results = TRUE, 
  message = FALSE, 
  comment = "")

```


## But de ce TP

Durant ce TP, vous serez amenés à effectuer les tâches suivantes: 

1. Manipuler une table de données génomique (les annotations du génome de la levure).
2. Sélectionner un sous-ensemble des données en filtrant les lignes sur base d'un critère déterminé (type d'annotation, chromosome).
3. Générer des graphiques pour représenter différents aspects liés à ces données.
4. Calculer des statistiques qui résument les différents types d'annotations. 

## Le format GTF

Le format **GTF** (**General Transfer Format**) est très largement utilisé pour fournir des annotations génomiques dans un format facilement lisible, tout en étant facilement manipulable au moyen de l'ordinateur. 

Fichiers textuels, 

- une ligne par "objet" génomique (gène, transcrit, exon, intron, CDS, ...) 
- une colonne par attribut  (nom, source, type d'objet, coordonnées génomique, description). 

Le format est décrit sur les sites suivants. 

- <http://www.ensembl.org/info/website/upload/gff.html>
- <https://genome.ucsc.edu/FAQ/FAQformat.html#format4>



## Localiser l'URL d'un fichier GTF

N'hésitez pas à adapter le protocole ci-dessous pour travailler avec votre propre génome. 

1. Connectez-vous à <http://ensemblgenomes.org/>. 
2. Cliquez sur le lien [Fungi](http://fungi.ensemblgenomes.org/). 
3. Cliquez [Download](http://fungi.ensembl.org/info/website/ftp/)
4. Dans la boîte **Filter**, tapez *Saccharomyces cerevisiae*. Pendant que vous écrivez, la liste des organismes proposés s'affine. 
5. Copiez le lien du fichier gtf ([Saccharomyces_cerevisiae.R64-1-1.41.gtf.gz](ftp://ftp.ensemblgenomes.org/pub/release-41/fungi/gtf/saccharomyces_cerevisiae/Saccharomyces_cerevisiae.R64-1-1.41.gtf.gz)). 

### Le chemin de la maison (automatique)

sous Linux et Mac OS X, on peut identifier la racine de son compte avec la commande **R** `Sys.getenv()`.

- Invoquée sans paramètre, cette commande liste toutes les variables d'environnement (votre configuration système). 

- On peut restreindre l'output à une variable d'environnement donnée, par exemple `Sys.getenv("HOME")` retourne le chemin de la racine de votre compte.

- Une écriture équivalente : le symbole tilde `~` indique également le chemin de la rachine de votre compte.  

- La notation '~' fonctionne également sous Windows, nous l'utiliserons donc ci-dessous. 


## Créer un espace de travail

**Exercice:**  créer un dossier de travail nommé `workDir` à la racine de votre compte, et déplacez-vous dans ce dossier. 

Solution ci-dessous.

```{r workdir}
## Define the working directory
workDir <- "~/intro_R/explorer_un_GTF"

## Create the working directory 
dir.create(workDir, recursive = TRUE, showWarnings = FALSE)

## Go to the working directory
setwd(workDir)
getwd()      ## Check your current location
list.files()  ## List files (should be empty if just created)
```

## Load the GTF file

**Exercise:** download the GTF file in the working directory (optionally, adapt the command to load a GTF of your interest). 

```{r download_gtf_from_ensembl}
## Define the file name (without path) in a separate variable, we will need it later
gtf.file <- 'Saccharomyces_cerevisiae.R64-1-1.41.gtf.gz'

## Define the URL by concatenating the URL of the directory and the file name
gtf.url <- file.path('ftp://ftp.ensemblgenomes.org/pub/release-41/fungi/gtf/saccharomyces_cerevisiae/', gtf.file)

## Download the file, but only if not yet there
if (file.exists(gtf.file)) {
  message("GTF annotation file already there: ", gtf.file)
} else {
  message("Downloading GTF annotation file")
  download.file(url = gtf.url, destfile = gtf.file)
}

## Check the files in the work directory
list.files()
```

## Loading the GTF file

Load the GTF file in a variable named `featureTable`.

**Tip:** command `read.delim`.

```{r load_yeast_gtf, echo=TRUE}
## Load GTF file in a data.frame
featureTable <- read.delim(
  gtf.file, comment.char = "#", sep="\t", 
  header=FALSE, row.names = NULL)

## The GTF format has no header, but we can define it based on the specification
names(featureTable) <- c("seqname", "source", "feature", "start", "end", "score", "strand", "frame", "attribute")

```

## Feature types

**Exercise:** the column *feature* of the GTF indicates the feature table. 

- List the feature types found in the GTF
- Count the number of features per type, and sort them by decreasing values. 

**Tip: ** commands `unique`, `table` and `sort`.


```{r features_per_type}
## List the types of features
unique(featureTable$feature)

## Count the number of features per type
sort(table(featureTable$feature), decreasing = TRUE)
```

## Select the subset of genes 

Count the number of genes in the GTF table. 

**Tip:** `help(subset)`

```{r genes}
## Select subset of features having "CDS" as "feature" attribute
genes <- subset(featureTable, feature == "gene")

## Print a message with the number of genes
message("Number of genes: ", nrow(genes))
```


## Calculer la longueur des gènes

Ajoutez une colonne avec la longueur des gènes, et calculer des indicateurs statistiques.

**Tip: ** `summary`

**Attention au calcul:** $L = \text{end} - \text{start} + 1$ (pourquoi ?) .

```{r cds_length_histo, out.width="90%", fig.width=10, fig.height=4, fig.cap="Distribution of cds lengths for Saccharomyces cerevisiae. ", echo=FALSE}
## Add a column to the table with genes lengths
genes$length <- genes$end - genes$start + 1

## Compute basic statistics on genes lengths
summary(genes$length)
```

## Histogramme de la longueur des gènes

Dessinez un histogramme de la longueur des gènes. 

**Tip:**: `hist`.

```{r}
## Compute max length
max.len <- max(genes$length)

## Plot an histogram with genes lengths
hist(genes$length, 
     breaks = seq(from = 0, to = max.len + 100, by = 100), 
     main = "genes length distribution", las = 1, 
     xlab = "genes length (bp)", ylab = "Number of geness", 
     border="darkblue", col = "lightblue")
par(mfrow = c(1,1))

```


### Téléchargement du fichier GTF à partir d'EnsemblGenomes

**Astuce: ** avant de télécharger le fichier d'annotations (GTF) depuis EnsemblGenomes vers notre ordinateur, nous allons vérifier s'il est déjà présent (et dans ce cas on ne le re-télécharge pas). 

```{r download_GTF}
## Define the file name (without path) in a separate variable, we will need it later
gtf.file <- 'Saccharomyces_cerevisiae.R64-1-1.41.gtf.gz'

## Define the URL by concatenating the URL of the directory and the file name
gtf.url <- file.path('ftp://ftp.ensemblgenomes.org/pub/release-41/fungi/gtf/saccharomyces_cerevisiae/', gtf.file)

## Define the path where the local copy will be stored
local.GTF <- file.path(workDir, "Saccharomyces_cerevisiae.R64-1-1.37.gtf.gz")

## If the local file file laready exists, skip the download
if (file.exists(local.GTF)) {
  message("GTF file already exists in the tutorial folder: ", local.GTF)
} else {
  ## Download annotation table in GTF format
  download.file(url = gtf.URL, destfile = local.GTF)
}
```

### Chargement d'un tableau de données

R comporte plusieurs types de structures tabulaires (matrix, data.frame, table). 

La structure la plus couramment utilisée est le `data.frame`, qui consiste en un tableau de valeurs (numériques ou chaînes de caractères) dont les lignes et les colonnes sont associées à des noms. 

La fonction `read.table()` permet de lire un fichier texte contenant un tableau de données, et de stocker le contenu dans une variable.

Plusieurs fonctions dérivées de `read.table()` facilitent la lecture de différents types de formats: 

- `read.delim()` pour les fichiers dont les colonnes sont délimitées par un caractère  particulier (généralement la tabulation, représentée par "\t").
- `read.csv()` pour les fichiers "comma-searated values".


1. Téléchargez le fichier suivant sur votre ordinateur: 

- [Saccharomyces_cerevisiae.R64-1-1.37.gtf](../../data/Saccharomyces_cerevisiae/Saccharomyces_cerevisiae.R64-1-1.37.gtf)

2. Chargez-le au moyen de la fonction read.table (pour cela vous devez remplacer le chemin ci-dessous par celui de votre ordinateur). 

```{r read.table, echo=TRUE, result=TRUE}
## Read a GTF file with yeast genome annotations

## Load the feature table
featureTable <- read.table(
  local.GTF, 
  comment.char = "#", 
  sep="\t", 
  header=FALSE, 
  row.names=NULL)

## The bed format does not contain any column header, 
## so we set it manually based on the description of the format, 
## found here: 
##     http://www.ensembl.org/info/website/upload/gff.html
names(featureTable) <- c("seqname", "source", "feature", "start", "end", "score", "strand", "frame", "attribute")


```

### Exploration du contenu d'un tableau de données

La première chose à faire après avoir chargé un tableau de données est de vérifier ses dimensions

```{r echo=TRUE, result=TRUE, warning=FALSE}
dim(featureTable) ## Dimensions of the tbale
nrow(featureTable) ## Number of rows
ncol(featureTable) ## Number of columns
```

L'affichage du tableau d'annotations complet ne serait pas très lisible, puisqu'il comporte des dizaines de milliers de lignes. 

Nous pouvons afficher les premières lignes avec la fonction `head()`. 

**Note: ** la dernière colonne est particulièrement lourde (elle contient un tas d'information). Nous verrons plus loin comment sélectionner un sous-ensemble des colonnes pour alléger l'affichage.  

```{r echo=TRUE, eval=TRUE, result=TRUE}
## Display the 5 first rows of the feature table
head(featureTable, n = 5) 
```

La fonction `tail()` affiche les dernières lignes:

```{r echo=TRUE, eval=TRUE, result=TRUE}
## Display the 5 last rows of the feature table
tail(featureTable, n = 5) 
```

If you are using the **RStudio** environment, you can display the table in a dynamic viewer pane with the function  `View()`.

```{r echo=TRUE, eval=FALSE}
## In RStudio, display the table in a separate tab
View(featureTable) 
```


### Sélection de sous-ensembles d'un tableau

Sélection d'une ligne spécifiée par son indice.

```{r echo=TRUE, eval=TRUE, result=TRUE}
featureTable[12,]
```

Sélection d'une colonne spécifiée par son indice (affichage des premières valeurs seulement.

```{r echo=TRUE, eval=TRUE, result=TRUE}
head(featureTable[,3])
```

Selection d'une cellule en combinant indices de ligne et colonne.

```{r echo=TRUE, eval=TRUE, result=TRUE}
featureTable[12, 3]
```

Sélection d'un bloc de colonnes et/ou de lignes.

```{r echo=TRUE, eval=TRUE, result=TRUE}
featureTable[100:105, 1:6]
```
Sélection de colonnes "à la carte" (ici, les coordonnées génomiques de chaque "feature"):  chromosome, début, fin, brin. 

```{r echo=TRUE, eval=TRUE, result=TRUE}
featureTable[100:105, c(1,4,5,7)]
```


Sélectionner une colonne sur base de son nom.

```{r echo=TRUE, eval=TRUE, result=TRUE}
## Select the "start" column and print the 100 first results
head(featureTable$start, n=100)

## Print the 20 first values of the "feature" field, which indicates the feature type
head(featureTable$feature, n=20)
```

Sélection de plusieurs colonnes sur base de leurs noms. 


```{r echo=TRUE, eval=TRUE, result=TRUE}
## Select the "start" column and print the 100 first results
featureTable[100:106, c("seqname", "start", "end", "strand")]
```

**Note**: il est également possible de nommer les lignes d'un data.frame mais le tableau GTF ne se prête pas à cela. Nous verrons d'autres exemples ultérieurement. 



### Sélection d'un sous-ensemble de lignes sur base du contenu d'une colonne

La fonction `subset()` permet de sélectionner un sous-ensemble des lignes d'un data.frame sur base d'une condition appliquée à une ou plusieurs colonnes. 

Nous pouvons l'appliquer pour sélectionner le sous-ensemble des lignes du tableau d'annotations correspondant à des séquences codantes (genes).

```{r echo=TRUE, eval=TRUE, result=TRUE}
## Select subset of features having "cds" as "feature" attribute
cds <- subset(featureTable, feature=="cds")

nrow(featureTable) ## Count the number of features
nrow(cds) ## Count the number of cds
```

### Décompte par valeur

La fonction `table()` permet de compter le nombre d'occurrences de chaque valeur dans un vecteur ou un tableau. Quelques exemples d'utilisation ci-dessous. 

```{r echo=TRUE, eval=TRUE, results=TRUE}
## Count the number of featues per chromosome
table(featureTable$seqname)

## Count the number of features per type
table(featureTable$feature)
```

On peut calculer des tables de contingence en comptant le nombre de combinaisons entre 2 vecteurs (ou 2 colonnes d'un tableau). 


```{r echo=TRUE, eval=TRUE, results=TRUE}
##  Table with two vectors
table(featureTable$feature, featureTable$seqname)

## Same result with a 2-column data frame
table(featureTable[, c("feature", "seqname")])
```

## Exercices

### 1. Spécifications du format GTF

Lisez les spécifications du format GTF.

- Ensembl (<http://www.ensembl.org/info/website/upload/gff.html>)
- UCSC (<https://genome.ucsc.edu/FAQ/FAQformat.html#format4>)

### 2. Création d'un dossier local pour le TP

Créez un dossier local (par exemple: `stat1/TP_levure` à partir de la racine de votre compte). Nous vous suggérons d'utiliser les fonctions suivantes: 

- `Sys.getenv("HOME")` (Linnux et Mac OS X), pour obtenir la racine de votre compte utilisateur;
- `file.path()` pour construire un chemin;
- `dir.create()` pour créer le dossier de ce TP. Lisez attendivement les options de cette fonction avec `help(dir.create)` 

### 3. Localisation du fichier d'annotations

Localisez le fichier d'annotations du génome de la levure en format GTF dans ce dossier local. 

- Site Ensembl Fungi: <http://fungi.ensembl.org/>
- Cliquez "Downloads" pour accéder au [site ftp](http://fungi.ensembl.org/info/website/ftp/)
- Dans la bo^îte de recherche, tapez *"saccharomyces cerevisiae"* et suivez le lien "[GTF](ftp://ftp.ensemblgenomes.org/pub/release-37/fungi/gtf/saccharomyces_cerevisiae)"
- COpiez l'adresse (URL) du ichier [Saccharomyces_cerevisiae.R64-1-1.37.gtf.gz](ftp://ftp.ensemblgenomes.org/pub/release-37/fungi/gtf/saccharomyces_cerevisiae/Saccharomyces_cerevisiae.R64-1-1.37.gtf.gz)


### 4. Téléchargement d'un fichier à partir d'un site ftp

Fonctions suggérées: 

- `download.file()` (lisez l'aide pour conna^tre les arguments)

### 5. Chargement d'une table de données en R

Ecrivez un script qui charge la table de données dans une variable nommée `featureTable`, en utilisant la fonction R `read.delim()`. 

Veillez à ignorer les lignes de commentaires (qui commencent par un caractère `#`). 


### 6. Calcul de la longueur des gènes codants


- Ajoutez à la table d'annotations (`featureTable`) une colonne intitulée "length" qui indique la longueur de chaque élément génomique annoté. 

```{r}
## Add a colmn with feature lengths
featureTable[, "length"] <- featureTable[, "end"] - featureTable[, "start"] + 1

## Add a colmn with feature lengths: equivalent result with simpler notation
featureTable$length <- featureTable$end - featureTable$start + 1
```


- Comptez le nombre de lignes de la table correspondant à chaque type d'annotation (3ème colonne du GTF, "feature"). 

    - fonction `table()`

```{r}
~table(featureTable$feature)
```


- Sélectionnez les lignes correspondant à des régions codantes ("CDS") 

    - fonction `subset()`

```{r}
cds <- subset(featureTable, feature=="CDS")
```


- Comptez le nombre de CDS par chromosome.

    - fonction `table()`


```{r}
table(cds$seqname)
```

- Chargez la table des tailles de chromosomes [chrom_sizes.tsv](../../data/Saccharomyces_cerevisiae/chrom_sizes.tsv), et calculez la densité de gènes pour chaque chromosome (nombre de gènes par Mb). 

```{r}
## Download tab-delimited file with chromosome sizes (unless already there)
annot.url <- "http://jvanheld.github.io/stat1/data/Saccharomyces_cerevisiae/chrom_sizes.tsv"
chrom.size.file <- file.path(workDir, "chrom_sizes.tsv")

if (!file.exists(chrom.size.file)) {
    download.file(annot.url, destfile = chrom.size.file)
}

## Read chromosome sizes
chrom.size <- read.delim(
  file = chrom.size.file,
  header = FALSE, row.names = 1)

## Assign a name to the columns
names(chrom.size) <- c("chromID", "size")
# View(chrom.size)

## print the size of hte third chromosome
chrom.size["III", "size"]

```


### 6. Histogramme de la longueur des gènes

Au moyen de la fonction `hist()`, dessinez un histogramme représentant la distribution de longueur des CDS. 

```{r}
hist(cds$length)
```

Choisissez les intervalles de classe de façon à ce que l'histogramme soit informaatif (ni trop ni trop peu de classes).

```{r}
## Take more or less 100 bins
h <- hist(cds$length, breaks=100)


```

Récupérez le résultat de `hist()` dans une variable nommée `cds.length.hist`.

```{r}
## Define breaks exactly in the way you wish
cds.length.hist <- hist(cds$length, breaks=seq(from=0, to=max(cds$length)+100, by=100))

```


Imprimez le résultat à l'écran (`print()`) et analysez la structure de la variable `cds.length.hist` (il s'agit d'une variable de type liste). 

Fonctions utiles: 
```{r}
## Display the values used to draw the histogram
print(cds.length.hist )

```

- `class(cds.length.hist)`
- `attributes(cds.length.hist)`


D'autres types de graphiques permettent d'explorer la distribution d'un ensemble des données. En particulier, les boîtes à moustaches (box plots) affichent, pour une série de données, la médiane, l'écart interquartile, un intervalle de confiance et les valeurs aberrantes. 

```{r fig.width=7, fig.height=5, fig.cap="Boîte à moustache indiquant la distribution de longueur des gènes par chromosome. "}
boxplot(length ~ seqname, data = cds, col="palegreen", horizontal=TRUE, las=1, xlab="Gene length", ylab="Chromosome")

```

<!--
## Rendu
-->
