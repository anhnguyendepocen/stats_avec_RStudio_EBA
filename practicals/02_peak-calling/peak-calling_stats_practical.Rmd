---
title: 'Practical: basic stats for peak calling'
author: "Jacques van Helden"
date: '`r Sys.Date()`'
output: ioslides_presentation
---

## Peak-calling: Carl's question

<center>![peak-calling question](images/peak-calling_the_question.png)</center>


## Defining the data directory

Open a connection to the lab web browser. 

We will first define the URL from which the data can be downloaded, by concatenating the URL fo the course with the path to our dataset.

To concatenate paths, it is *recommended* to use the **R** command `file.path()`.

<small>
```{r}
url.course <- "http://jvanheld.github.io/EBA15_stats_RStudio/"
url.data <- file.path(url.course, "practicals", "02_peak-calling", "data")
```
</small>


## Loading a data table

**R** enables to download data directly from the Web. 

Load counts per window in chip sample.

#```{r}
### load data tables as data.frames

## ChIP IP counts in windows of 1kb or 10 kb
#ip.1kb <- read.table(file.path(url.data,'SRR540190_GSM986061_siNT_ER_E2_r2_sorted.chr21.1kb.cov'))
#ip.10kb <- read.table(file.path(url.data,'SRR540190_GSM986061_siNT_ER_E2_r2_sorted.chr21.10kb.cov'))

## ChIP input counts in windows of 1kb or 10 kb
#input.1kb <- read.table(file.path(url.data,'SRR540220_GSM986091_MCF_input_r3_sorted.chr21.1kb.cov'))
#input.10kb <- read.table(file.path(url.data,'SRR540220_GSM986091_MCF_input_r3_sorted.chr21.10kb.cov'))


#```


```{r}
## Define URL of the ChIP file
chip.bedg.file <- file.path(url.data, "FNR_200bp.bedg")

## Load the file content in an R data.frame
chip.bedg <- read.table(chip.bedg.file)

## Set column names
names(chip.bedg) <- c("chrom", "start", "end","counts")
```

## Exploring a data frame: dim()

Before anything else, let us inspect the size of the data frame, in order to check that it was properly lodaded.

```{r}
dim(chip.bedg)
```


## Checking the n first rows: head()

The function `head()` displays the first rows of a table.

```{r}
head(chip.bedg, n = 5)
```

## Checking the n last rows: tail()

The function `tail()` displays the first rows of a table.

```{r}
head(chip.bedg, n = 5)
```

## Viewing a table

The function `View()` displays the full table in a user-friendly mode.

```{r eval=FALSE}
View(chip.bedg)
```

## Selecting arbitrary rows

```{r}
chip.bedg[100:105,] 
```


## Selecting arbitrary columns

```{r}
chip.bedg[100:105, 2] 
chip.bedg[100:105, "start"] 
chip.bedg[100:105, c("start", "counts")] 
```

## Adding columns

We can add columns with the result of computations from other columns.

```{r}
chip.bedg$midpos <- (chip.bedg$start + chip.bedg$end)/2
head(chip.bedg)
```


## Plotting a density profile

We can readily print a plot with the counts per window.

```{r}
plot(chip.bedg[, c("midpos", "counts")], type="h")
```

## Plotting a density profile

Let us improve the plot

```{r}
plot(chip.bedg[, c("midpos", "counts")], type="h", 
     col="blue", xlab="Genomic position (200bp windows)", 
     ylab= "Read counts",
     main="FNR ChIP-seq")
```


## Exercise: exploring the background

We already loaded the count table for the FNR ChIP counts per window. 

The background level will be estimated by loading counts per window in a genomic input sample.
These counts are available in the same directory a file named `input_200bp.bedg`

1. Load the counts per window in the input sample (genome sequencing).
2. Plot the density profile of the input
3. Compare  chip-seq and input density profiles
4. Compare counts per window between chip-seq and input

## Solution: loading the input counts per window

```{r}
## Define URL of the input file
input.bedg.file <- file.path(url.data, "input_200bp.bedg")

## Load the file content in an R data.frame
input.bedg <- read.table(input.bedg.file)

## Set column names
names(input.bedg) <- c("chrom", "start", "end","counts")

```

## Solution: plotting the input density profile

```{r}
## Compute middle positions per window
input.bedg$midpos <- (input.bedg$start + input.bedg$end)/2

plot(input.bedg[, c("midpos", "counts")], type="h", 
     col="red", xlab="Genomic position (200bp windows)", 
     ylab= "Read counts",
     main="Background (genomic input)")
```

## Solution: comparing chip-seq and background density profiles

```{r}
par(mfrow=c(2,1)) ## Draw two panels on top of each other
plot(chip.bedg[, c("midpos", "counts")], type="h", 
     col="blue", xlab="Genomic position (200bp windows)", 
     ylab= "Read counts",
     main="FNR ChIP-seq")
plot(input.bedg[, c("midpos", "counts")], type="h", 
     col="red", xlab="Genomic position (200bp windows)", 
     ylab= "Read counts",
     main="Background (genomic input)")
par(mfrow=c(1,1)) ## Reset default mode

```

## Solution: comparing counts per window between chip-seq and input

```{r}
plot(input.bedg$counts, chip.bedg$counts, col="violet",
     xlab="Genomic input", ylab="FNR ChIP-seq",
     main="Read counts per 200bp window")
```

## Solution: comparing counts per window between chip-seq and input

In order to better highight the dynamic range, we can use a log-based representation

```{r}
plot(input.bedg$counts, chip.bedg$counts, log="xy")
```


